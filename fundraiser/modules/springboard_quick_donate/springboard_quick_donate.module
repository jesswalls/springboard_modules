<?php
/**
 * @file
 * Module file for springboard_quick_donate.
 */

require_once __DIR__ . '/includes/springboard_quick_donate.fundraiser.inc';
require_once __DIR__ . '/includes/springboard_quick_donate.node_form.inc';
require_once __DIR__ . '/includes/springboard_quick_donate.springboard_hmac.inc';

/**
 * Implements hook_menu().
 */
function springboard_quick_donate_menu() {
  $items = array();

  $items['admin/config/system/fundraiser/quick-donate/token-generator'] = array(
    'title' => 'Quick Donate Token Generator',
    'description' => 'Generate quick donate HMAC tokens for testing or use',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('springboard_quick_donate_token_generator'),
    'access arguments' => array('administer fundraiser quick_donate'),
    'file' => 'includes/springboard_quick_donate.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Implements hook_views_api().
 */
function springboard_quick_donate_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'springboard_quick_donate') . '/includes/views',
  );
}

/**
 * Implements hook_FORM_ID_alter().
 *
 * Used to add a quick donation related message.
 */
function springboard_quick_donate_form_user_login_alter(&$form, &$form_state) {
  drupal_session_start();
  $destination = drupal_get_destination();
  if (isset($_SESSION['quickdonate']) && $_SESSION['quickdonate'] && !empty($destination)) {
    $destination = $destination['destination'];
    $form['#prefix'] = t("Please login to verify your identity. Or if you'd prefer, you may !proceed.", array(
      '!proceed' => l(t('proceed to the full donation form'), $destination),
    ));
  }
}

/**
 * Implements hook_node_load().
 */
function springboard_quick_donate_node_load($nodes, $types) {
  $fundraiser_types = fundraiser_get_donation_types();
  $fundraiser_types = array_filter($fundraiser_types);
  $fundraiser_types = array_keys($fundraiser_types);
  if (!array_intersect($fundraiser_types, $types)) {
    return;
  }

  foreach ($nodes as $nid => $node) {
    _springboard_quick_donate_attach_quick_donate_fields($nodes[$nid]);
  }
}

/**
 * Implements hook_node_prepare().
 */
function springboard_quick_donate_node_prepare($node) {
  if (!fundraiser_is_donation_type($node->type)) {
    return;
  }

  _springboard_quick_donate_attach_quick_donate_fields($node);
}

/**
 * Helper function to attach quick donation settings to a node.
 *
 * @param object $node
 *   The node object.
 *
 * @return object
 *   The modified node object.
 */
function _springboard_quick_donate_attach_quick_donate_fields(stdClass $node) {
  $query = db_select('fundraiser_springboard_quick_donate', 'sqd')
    ->fields('sqd', array(
      'quickdonate_optin_message',
      'quickdonate_help_message_format',
      'quickdonate_help_message',
      'quickdonate_login_message',
      'quickdonate_login_link_message',
    ))
    ->condition('fundraiser_nid', $node->nid, '=')
    ->execute();

  if (!$query->rowCount()) {
    return $node;
  }

  $results = $query->fetchAssoc();
  foreach ($results as $key => $result) {
    $node->{$key} = $result;
  }
  $node->quickdonate = TRUE;
  return $node;
}

/**
 * Implements hook_fundraiser_field_info().
 */
function springboard_quick_donate_fundraiser_field_info_alter(&$fields) {
  $fields['payment_information']['quick_donate'] = array(
    '#type' => 'checkbox',
    '#title' => variable_get('springboard_quick_donate_default_optin_message', t('Save this card for future use')),
  );
  return $fields;
}

/**
 * Implements hook_payment_method_fields_alter().
 */
function springboard_quick_donate_payment_method_fields_alter(&$element, &$payment_method, &$context) {
  $element['quickdonate'] = array(
    '#type' => 'hidden',
    '#value' => 'false',
  );
}

/**
 * Implements hook_webform_user_save_profile_map_alter().
 */
function springboard_quick_donate_webform_user_save_profile_map_alter(&$account, $form, $form_state) {
  if (isset($form['#node']['quickdonate']) && $form['#node']['quickdonate']) {
    $account->quickdonate_optin_date = time();
    if (isset($_SESSION['springboard_hmac']['quickdonate'])) {
      module_load_include('inc', 'springboard_quick_donate', 'includes/springboard_quick_donate.springboard_hmac');
      $mapping = _springboard_hmac_quick_mapping();
      $account->quickdonate_market_source = $_SESSION['springboard_hmac']['quickdonate'][$mapping['ms']];
    }
  }
}
